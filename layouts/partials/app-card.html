{{/* App card partial - displays a single app */}}
{{ $appId := .id }}
{{ $name := .name }}
{{ $url := .url }}
{{ $description := .description }}
{{ $platforms := .platforms }}
{{ $api := .api }}
{{ $screenshots := .screenshots }}
{{ $repoUrl := .repoUrl }}
{{ $isFree := .isFree }}

{{/* Build full path to thumbnail */}}
{{ $thumbnailPath := printf "apps/%s/%s" $appId $screenshots.thumbnail }}
{{ $thumbnail := resources.Get $thumbnailPath }}

{{/* Build data attributes for filtering */}}
{{ $platformsList := slice }}
{{ if $platforms.android }}{{ $platformsList = $platformsList | append "android" }}{{ end }}
{{ if $platforms.ios }}{{ $platformsList = $platformsList | append "ios" }}{{ end }}
{{ if $platforms.windows }}{{ $platformsList = $platformsList | append "windows" }}{{ end }}
{{ if $platforms.linux }}{{ $platformsList = $platformsList | append "linux" }}{{ end }}
{{ if $platforms.macos }}{{ $platformsList = $platformsList | append "macos" }}{{ end }}
{{ if $platforms.web }}{{ $platformsList = $platformsList | append "web" }}{{ end }}
{{ if $platforms.other }}{{ $platformsList = $platformsList | append "other" }}{{ end }}
{{ $platformsAttr := delimit $platformsList " " }}

{{ $apiLower := lower $api }}

{{ $ossAttr := cond $repoUrl "true" "false" }}
{{/* Open source apps are automatically considered free */}}
{{ $isActuallyFree := or $isFree $repoUrl }}
{{ $freeAttr := cond $isActuallyFree "true" "false" }}

{{ $keywords := default (slice) .keywords }}
{{ $searchable := printf "%s %s %s" $name $description (delimit $keywords " ") | lower }}

<div class="app-card" 
     data-platforms="{{ $platformsAttr }}" 
     data-apis="{{ $apiLower }}" 
     data-oss="{{ $ossAttr }}" 
     data-free="{{ $freeAttr }}" 
     data-searchable="{{ $searchable }}">
  <div class="app-thumbnail-container" data-app-id="{{ $appId }}">
    {{ if $thumbnail }}
      <img src="{{ $thumbnail.RelPermalink }}" alt="{{ $name }}" class="app-thumbnail" loading="lazy">
    {{ end }}
    <div class="app-thumbnail-overlay">
      <i class="fas fa-search-plus"></i>
    </div>
  </div>

  <div class="app-content">
    <h3 class="app-name">
      <a href="{{ $url }}" target="_blank" rel="noopener">{{ $name }}</a>
      {{ if $repoUrl }}
        <a href="{{ $repoUrl }}" target="_blank" rel="noopener" class="app-oss-badge" title="Open Source">
          <i class="fab fa-github"></i>
        </a>
      {{ end }}
      {{/* Show free badge only if free but not open source (to avoid redundancy) */}}
      {{ if and $isActuallyFree (not $repoUrl) }}
        <span class="app-free-badge" title="Free">
          <i class="fas fa-tag"></i>
        </span>
      {{ end }}
    </h3>

    <p class="app-description">{{ $description }}</p>

    <div class="app-metadata">
      {{/* Platform icons */}}
      <div class="app-platforms">
        {{ if $platforms.android }}
          {{ if and (ne (printf "%T" $platforms.android) "bool") (isset $platforms.android "store") }}
            <a href="{{ $platforms.android.store }}" target="_blank" rel="noopener" title="Android">
              <i class="fab fa-android"></i>
            </a>
          {{ else }}
            <span title="Android"><i class="fab fa-android"></i></span>
          {{ end }}
        {{ end }}
        {{ if $platforms.ios }}
          {{ if and (ne (printf "%T" $platforms.ios) "bool") (isset $platforms.ios "store") }}
            <a href="{{ $platforms.ios.store }}" target="_blank" rel="noopener" title="iOS">
              <i class="fab fa-apple"></i>
            </a>
          {{ else }}
            <span title="iOS"><i class="fab fa-apple"></i></span>
          {{ end }}
        {{ end }}
        {{ if $platforms.macos }}
          {{ if and (ne (printf "%T" $platforms.macos) "bool") (isset $platforms.macos "store") }}
            <a href="{{ $platforms.macos.store }}" target="_blank" rel="noopener" title="macOS">
              <i class="fas fa-laptop"></i>
            </a>
          {{ else }}
            <span title="macOS"><i class="fas fa-laptop"></i></span>
          {{ end }}
        {{ end }}
        {{ if $platforms.windows }}
          <span title="Windows"><i class="fab fa-windows"></i></span>
        {{ end }}
        {{ if $platforms.linux }}
          <span title="Linux"><i class="fab fa-linux"></i></span>
        {{ end }}
        {{ if $platforms.web }}
          <span title="Web"><i class="fas fa-globe"></i></span>
        {{ end }}
      </div>

      {{/* API badges */}}
      <div class="app-apis">
        {{ $apiClass := $api | lower | replaceRE "[^a-z0-9]+" "-" }}
        {{ $apiTooltip := "" }}
        {{ if eq $apiClass "subsonic" }}
          {{ $apiTooltip = "Original Subsonic API - basic music streaming features" }}
        {{ else if eq $apiClass "opensubsonic" }}
          {{ $apiTooltip = "Modern extension of Subsonic API with additional features like multi-valued tags and more" }}
        {{ else if eq $apiClass "navidrome" }}
          {{ $apiTooltip = "Navidrome-specific API with advanced features beyond OpenSubsonic" }}
        {{ end }}
        <span class="api-badge api-{{ $apiClass }}" title="{{ $apiTooltip }}">{{ $api }}</span>
      </div>
    </div>
  </div>

  {{/* Hidden data for gallery */}}
  {{ if $screenshots.gallery }}
    <div class="app-gallery-data" data-app-id="{{ $appId }}" style="display:none;">
      {{ range $screenshots.gallery }}
        {{ $galleryPath := printf "apps/%s/%s" $appId . }}
        {{ $galleryImg := resources.Get $galleryPath }}
        {{ if $galleryImg }}
          <span data-src="{{ $galleryImg.RelPermalink }}"></span>
        {{ end }}
      {{ end }}
    </div>
  {{ end }}
</div>
