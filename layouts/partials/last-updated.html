{{- /*
  Last Updated Partial

  Fetches the last release/update date from various sources at build time.

  Parameters:
    - appId: App identifier (used for warning messages)
    - repoUrl: Repository URL (GitHub or GitLab)
    - platforms: Platform dict with potential docker.store URL

  Returns: dict with:
    - display: YYYY-MM-DD formatted date string for display, or "N/A" if unavailable
    - attr: YYYY-MM-DD formatted date string for data attribute (empty if unavailable)
*/ -}}
{{- $appId := .appId -}}
{{- $repoUrl := .repoUrl -}}
{{- $platforms := .platforms -}}
{{- $date := "" -}}

{{- /* Try GitHub first */ -}}
{{- if and (not $date) $repoUrl (strings.Contains $repoUrl "github.com") -}}
  {{- $date = partial "last-updated/github.html" (dict "appId" $appId "repoUrl" $repoUrl) -}}
{{- end -}}

{{- /* Try GitLab */ -}}
{{- if and (not $date) $repoUrl (strings.Contains $repoUrl "gitlab.com") -}}
  {{- $date = partial "last-updated/gitlab.html" (dict "appId" $appId "repoUrl" $repoUrl) -}}
{{- end -}}

{{- /* Try cgit/self-hosted git repos via Atom feed */ -}}
{{- if and (not $date) $repoUrl -}}
  {{- $date = partial "last-updated/cgit.html" (dict "appId" $appId "repoUrl" $repoUrl) -}}
{{- end -}}

{{- /* Try Docker Hub from platforms.docker.store */ -}}
{{- if and (not $date) $platforms $platforms.docker -}}
  {{- $dockerStore := "" -}}
  {{- if ne (printf "%T" $platforms.docker) "bool" -}}
    {{- if isset $platforms.docker "store" -}}
      {{- $dockerStore = $platforms.docker.store -}}
    {{- end -}}
  {{- end -}}
  {{- if and $dockerStore (strings.Contains $dockerStore "hub.docker.com") -}}
    {{- $date = partial "last-updated/dockerhub.html" (dict "appId" $appId "storeUrl" $dockerStore) -}}
  {{- else if and $dockerStore (strings.Contains $dockerStore "ghcr.io") -}}
    {{- $date = partial "last-updated/ghcr.html" (dict "appId" $appId "storeUrl" $dockerStore) -}}
  {{- end -}}
{{- end -}}

{{- /* Try Apple App Store from platforms.ios/tvos/macos.store */ -}}
{{- if not $date -}}
  {{- range slice "ios" "tvos" "macos" -}}
    {{- if and (not $date) (index $platforms .) -}}
        {{- $platformData := index $platforms . -}}
        {{- $storeUrl := "" -}}
        {{- if ne (printf "%T" $platformData) "bool" -}}
             {{- if isset $platformData "store" -}}
                 {{- $storeUrl = $platformData.store -}}
             {{- end -}}
        {{- end -}}
        {{- if and $storeUrl (or (strings.Contains $storeUrl "apps.apple.com") (strings.Contains $storeUrl "itunes.apple.com")) -}}
            {{- $date = partial "last-updated/apple.html" (dict "appId" $appId "storeUrl" $storeUrl) -}}
        {{- end -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- /* Try Play Store from platforms.android.store */ -}}
{{- if and (not $date) $platforms $platforms.android -}}
  {{- $playStore := "" -}}
  {{- if ne (printf "%T" $platforms.android) "bool" -}}
    {{- if isset $platforms.android "store" -}}
      {{- $playStore = $platforms.android.store -}}
    {{- end -}}
  {{- end -}}
  {{- if and $playStore (strings.Contains $playStore "play.google.com") -}}
    {{- $date = partial "last-updated/playstore.html" (dict "appId" $appId "storeUrl" $playStore) -}}
  {{- end -}}
{{- end -}}

{{- /* Return dict with display and attr values */ -}}
{{- $date = strings.TrimSpace $date -}}
{{- if eq $date "" -}}
  {{- warnf "[last-updated] app=%s: could not determine last-updated date from any source (repoUrl=%v)" $appId (cond (not $repoUrl) "none" $repoUrl) -}}
{{- end -}}
{{- return dict "display" (cond (eq $date "") "N/A" $date) "attr" $date -}}
