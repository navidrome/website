{{ define "main" }}

{{ .Content }}

<div class="td-content apps-page-content">
  {{/* Load all app data from apps/ directory */}}
  {{ $apps := slice }}
  {{ range (resources.Match "apps/*/index.yaml") }}
    {{ $appData := . | transform.Unmarshal }}
    {{/* Extract app ID from path (e.g., "apps/dsub/index.yaml" -> "dsub") */}}
    {{ $pathParts := split .Name "/" }}
    {{ $appId := "" }}
    {{ if ge (len $pathParts) 2 }}
      {{ $appId = index $pathParts (sub (len $pathParts) 2) }}
    {{ end }}
    {{/* Skip template */}}
    {{ if and (ne $appId "_template") (ne $appId "") }}
      {{ $appData = merge $appData (dict "id" $appId) }}
      {{ $apps = $apps | append $appData }}
    {{ end }}
  {{ end }}

  {{/* Sort apps alphabetically by name */}}
  {{ $apps = sort $apps "name" }}

  {{/* Filter panel */}}
  <div class="app-filters" role="search">
    {{/* Mobile toggle button */}}
    <button id="filter-toggle" class="filter-toggle" aria-expanded="false">
      <i class="fas fa-filter"></i> Filter & Search (<span class="filter-count">{{ len $apps }}</span> apps)
    </button>

    {{/* Filter controls */}}
    <div id="filter-panel" class="filter-panel">
      {{/* Search box */}}
      <div class="filter-row filter-search">
        <input 
          type="search" 
          id="app-search" 
          class="app-search-input" 
          placeholder="Search apps by name or features (e.g., CarPlay, offline)..."
          data-placeholder-mobile="Search apps by name or features..."
          aria-label="Search apps by name or features"
        >
        <i class="fas fa-search search-icon"></i>
      </div>

      {{/* Platform filters */}}
      <div class="filter-row filter-platforms">
        <span class="filter-label">Platform:</span>
        <div class="filter-checkboxes">
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="android">
            <span><i class="fab fa-android"></i> Android</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="ios">
            <span><i class="fab fa-apple"></i> iOS</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="windows">
            <span><i class="fab fa-windows"></i> Windows</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="linux">
            <span><i class="fab fa-linux"></i> Linux</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="macos">
            <span><i class="fas fa-laptop"></i> macOS</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="web">
            <span><i class="fas fa-globe"></i> Web</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="docker">
            <span><i class="fab fa-docker"></i> Docker</span>
          </label>
          <label class="filter-checkbox">
            <input type="checkbox" name="platform" value="other">
            <span><i class="fas fa-ellipsis-h"></i> Other</span>
          </label>
        </div>
      </div>

      {{/* API & OSS filters */}}
      <div class="filter-row filter-apis-oss">
        <div class="filter-apis">
          <span class="filter-label">API:</span>
          <div class="filter-checkboxes">
            <label class="filter-checkbox" title="Original Subsonic API - basic music streaming features">
              <input type="checkbox" name="api" value="subsonic">
              <span>Subsonic</span>
            </label>
            <label class="filter-checkbox" title="Modern extension of Subsonic API with additional features like multi-valued tags and more">
              <input type="checkbox" name="api" value="opensubsonic">
              <span>OpenSubsonic</span>
            </label>
            <label class="filter-checkbox" title="Navidrome-specific API with advanced features beyond OpenSubsonic">
              <input type="checkbox" name="api" value="navidrome">
              <span>Navidrome</span>
            </label>
          </div>
        </div>

        <label class="filter-checkbox filter-oss">
          <input type="checkbox" id="filter-oss" name="oss">
          <span><i class="fab fa-github"></i> Open Source Only</span>
        </label>

        <label class="filter-checkbox filter-free">
          <input type="checkbox" id="filter-free" name="free">
          <span><i class="fas fa-tag"></i> Free Only</span>
        </label>

        <div class="filter-sort">
          <label for="sort-select" class="filter-label">Sort by:</label>
          <select id="sort-select" class="sort-select">
            <option value="name">Name (A-Z)</option>
            <option value="updated">Last Updated</option>
          </select>
        </div>

        <button id="clear-filters" class="clear-filters-btn">
          <i class="fas fa-times"></i> Clear All Filters
        </button>
      </div>

      {{/* Results count */}}
      <div class="filter-results" aria-live="polite">
        <span id="results-count">Showing all {{ len $apps }} apps</span>
      </div>
    </div>

    {{/* Empty state */}}
    <div id="empty-state" class="empty-state" style="display: none;">
      <i class="fas fa-search"></i>
      <p>No apps found</p>
      <p class="empty-state-hint">Try adjusting your filters</p>
    </div>
  </div>

  <div class="apps-grid">
    {{ range $apps }}
      {{ partial "app-card.html" . }}
    {{ end }}
  </div>

  {{/* Include gallery modal */}}
  {{ partial "app-gallery.html" . }}

  {{/* Include app filters script */}}
  <script src="{{ "js/app-filters.js" | relURL }}"></script>
</div>

{{ end }}
